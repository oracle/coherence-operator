{{/* Copyright 2019, Oracle Corporation and/or its affiliates.  All rights reserved.*/}}
{{/* Licensed under the Universal Permissive License v 1.0 as shown at*/}}
{{/* http://oss.oracle.com/licenses/upl.*/}}
{{/* */}}
{{- $utilsImage := required "A value is required for the value .Values.coherence.images.coherenceUtils.image" .Values.coherence.images.coherenceUtils.image -}}
{{- $cohImage := required "A value is required for the value .Values.coherence.images.coherence.image" .Values.coherence.images.coherence.image -}}
{{- $extLibDir := "/u01/oracle/oracle_home/coherence/ext/lib" -}}
{{- $extConfDir := "/u01/oracle/oracle_home/coherence/ext/conf" -}}
{{- define "rootCoherenceSnapshot" }}
- mountPath: "/root/coherence/snapshot"
  name: snapshot-volume
{{- end }}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ template "coherence.fullname" . }}
  labels:
    {{- include "coherence.release_labels" . | indent 4 }}
    component: coherence
spec:
  replicas: {{ .Values.replicas | default 3 | int }}
  podManagementPolicy: Parallel
  updateStrategy:
    type: RollingUpdate
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      coherenceDeployment: {{ template "coherence.fullname" . }}
      component: coherencePod
  serviceName: {{ template "coherence.name" . }}
  template:
    metadata:
      labels:
{{- include "coherence.release_labels" . | indent 8 }}
        component: coherencePod
{{- if .Values.labels }}
{{ toYaml .Values.labels | indent 8 }}
{{- end }}
      annotations:
        prometheus.io/port: "9612"
        prometheus.io/scrape: "true"
{{- if .Values.annotations }}
{{ toYaml .Values.annotations | indent 8 }}
{{- end }}
    spec:
{{- if .Values.serviceAccountName }}
{{-   if not ((eq .Values.serviceAccountName "default")) }}
      serviceAccountName: {{ .Values.serviceAccountName }}
{{-   end }}
{{- end }}
{{- if .Values.imagePullSecrets }}
{{-   range .Values.imagePullSecrets }}
      - name: {{ . }}
{{-   end }}
{{- end }}
{{/* --------------------------------------------------------------------------- */}}
{{/* Node scheduling                                                             */}}
{{/* --------------------------------------------------------------------------- */}}
{{- if .Values.tolerations }}
      tolerations:
{{ toYaml .Values.tolerations | indent 8 }}
{{- end }}
{{- if .Values.affinity }}
      affinity:
{{ toYaml .Values.affinity | indent 8 }}
{{- else }}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: coherenceCluster
                  operator: In
                  values:
                  - {{ template "coherence.clusterName" . }}
                - key: coherenceRole
                  operator: In
                  values:
                  - {{ template "coherence.role" . }}
              topologyKey: failure-domain.beta.kubernetes.io/zone
{{- end }}
{{- if .Values.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.nodeSelector | indent 8 }}
{{- end }}
# ---------------------------------------------------------------------------
#  Containers:
# ---------------------------------------------------------------------------
      initContainers:
# ---------------------------------------------------------------------------
#  Container: For adding required artifacts e.g. startup scripts to the pod.
# ---------------------------------------------------------------------------
        - name: coherence-k8s-utils
          image: {{ .Values.coherence.images.coherenceUtils.image | quote }}
{{- if .Values.coherence.images.coherenceUtils.imagePullPolicy }}
          imagePullPolicy: {{ .Values.coherence.images.coherenceUtils.imagePullPolicy }}
{{- end }}
          env:
          - name: COH_UTIL_DIR
            value: "/utils"
          volumeMounts:
          - name: utils-dir
            mountPath: /utils
{{- if .Values.coherence.persistence }}
{{-   if .Values.coherence.persistence.enabled }}
          - mountPath: "/persistence"
            name: persistence-volume
{{-   end }}
{{- end }}
{{- if .Values.coherence.snapshot }}
{{-   if .Values.coherence.snapshot.enabled }}
          - mountPath: "/snapshot"
            name: snapshot-volume
{{-   else if .Values.coherence.snapshot.volume }}
{{-     if .Values.coherence.persistence }}
{{-       if .Values.coherence.persistence.enabled }}
{{- include "rootCoherenceSnapshot" . | indent 12 }}
{{-       end }}
{{-     else }}
{{- include "rootCoherenceSnapshot" . | indent 12 }}
{{-     end }}
{{-   end }}
{{- end }}
          command: [ "/files/utils-init" ]
# ---------------------------------------------------------------------------
#  Container: application artifacts
# ---------------------------------------------------------------------------
{{- if and .Values.application.image }}
        - name: user-artifacts
          image: {{ .Values.application.image | quote }}
{{-     if .Values.application.imagePullPolicy }}
          imagePullPolicy: {{ .Values.application.imagePullPolicy }}
{{-     end }}
          env:
          - name: "EXTERNAL_LIB_DIR"
            value: {{ $extLibDir }}
          - name: "LIB_DIR"
            value: {{ .Values.application.libDir | default "/files/lib" | quote }}
          - name: "EXTERNAL_CONF_DIR"
            value: {{ $extConfDir }}
          - name: "CONF_DIR"
            value: {{ .Values.application.configDir | default "/files/conf" | quote }}
          volumeMounts:
          - name: utils-dir
            mountPath: /utils
          - name: application-artifacts-dir
            mountPath: {{ $extLibDir | quote }}
          - name: application-conf-dir
            mountPath: {{ $extConfDir | quote }}
          command: [ "/utils/copy"]
{{- end }}
      containers:
# ---------------------------------------------------------------------------
#  Container: coherence
# ---------------------------------------------------------------------------
        - name: "coherence"
          image: {{ .Values.coherence.images.coherence.image | quote }}
{{- if .Values.coherence.images.coherence.imagePullPolicy }}
          imagePullPolicy: {{ .Values.coherence.images.coherence.imagePullPolicy }}
{{- end }}
          ports:
            - name: "mgmt-port"
              containerPort: 30000
            - name: "metrics-port"
              containerPort: 9612
{{- if eq (default false .Values.jvm.debug.enabled) true }}
            - name: "debug-port"
              containerPort: 5005
{{- end }}
{{- if .Values.ports -}}
{{-   range $port := .Values.ports }}
            - name: {{ $port.name | quote }}
              containerPort: {{ $port.port }}
              protocol: {{ $port.protocol | default "TCP" }}
{{-   end }}
{{- end }}
          env:
{{- if .Values.env -}}
{{ toYaml .Values.env | nindent 12 }}
{{- end }}
            - name: COH_WKA
              value: {{ .Values.wka }}
            - name: COH_EXTRA_CLASSPATH
              value: {{ printf "%s/*:%s" $extLibDir $extConfDir | quote }}
            - name: COH_MGMT_HTTP_PORT
              value: "30000"
            - name: COH_METRICS_PORT
              value: "9612"
            - name: COH_MACHINE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: COH_MEMBER_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: OPERATOR_HOST
              valueFrom:
                secretKeyRef:
                  name: coherence-operator-config
                  key: operatorhost
                  optional: true
            - name: COH_SITE_INFO_LOCATION
              value: http://$(OPERATOR_HOST)/site/$(COH_MACHINE_NAME)
            - name: COH_RACK_INFO_LOCATION
              value: http://$(OPERATOR_HOST)/rack/$(COH_MACHINE_NAME)
            - name: COH_CLUSTER_NAME
              value: {{ template "coherence.clusterName" . }}
            - name: COH_ROLE
              value: {{ template "coherence.role" . }}
            - name: COH_UTIL_DIR
              value: "/utils"
{{/* */}}
{{/* ----- Application variables -------------------------------------------- */}}
{{/* */}}
{{- if .Values.application }}
{{-   if .Values.application.type }}
            - name: APP_TYPE
              value: {{ .Values.application.type | quote }}
{{-   end }}
{{-   if .Values.application.mainClass }}
            - name: COH_MAIN_CLASS
              value: {{ .Values.application.mainClass | quote }}
{{-   end }}
{{-   if .Values.application.args }}
            - name: COH_MAIN_ARGS
              value: {{ join " " .Values.application.args | quote }}
{{-   end }}
{{- end }}
{{/* */}}
{{/* ----- JVM variables ---------------------------------------------------- */}}
{{/* */}}
{{- if .Values.jvm }}
{{-   if .Values.jvm.maxHeap }}
            - name: MAX_HEAP
              value: {{ .Values.jvm.maxHeap | quote }}
{{-   end }}
{{-   if .Values.jvm.gc }}
            - name: JVM_GC_OPTS
              value: {{ .Values.jvm.gc | quote }}
{{-   end }}
{{-   if .Values.jvm.args }}
            - name: JVM_ARGS
              value: {{ join " " .Values.jvm.args | quote }}
{{-   end }}
{{-   if .Values.jvm.debug }}
{{-     if eq (default false .Values.jvm.debug.enabled) true }}
            - name: DEBUG_ENABLED
              value: "true"
{{-       if .Values.jvm.debug.attach }}
            - name: DEBUG_ATTACH
              value: {{ .Values.jvm.debug.attach | quote }}
{{-       end }}
{{-     end }}
{{-   end }}
{{- end }}
{{/* */}}
{{/* ----- Coherence variables ---------------------------------------------- */}}
{{/* */}}
{{- if .Values.coherence.cacheConfig }}
            - name: COH_CACHE_CONFIG
              value: {{ .Values.coherence.cacheConfig | quote }}
{{- end }}
{{- if .Values.coherence.overrideConfig }}
            - name: COH_OVERRIDE_CONFIG
              value: {{ .Values.coherence.overrideConfig | quote }}
{{- end }}
{{- if .Values.coherence.pofConfig }}
            - name: COH_POF_CONFIG
              value: {{ .Values.coherence.pofConfig | quote }}
{{- end }}
{{- $storageEnabled := toString .Values.coherence.storageEnabled }}
{{- if eq $storageEnabled "true" }}
            - name: COH_STORAGE_ENABLED
              value: "true"
{{- else if eq $storageEnabled "false" }}
            - name: COH_STORAGE_ENABLED
              value: "false"
{{- end }}
{{- if .Values.coherence.curlTimeout }}
            - name: CURL_TIMEOUT
              value: {{ .Values.coherence.curlTimeout | quote }}
{{- end }}
{{- if .Values.coherence.persistence }}
{{-   if .Values.coherence.persistence.enabled }}
            - name: COH_PERSISTENCE_ENABLED
              value: "true"
{{-   end }}
{{- end }}
{{- if .Values.coherence.snapshot }}
{{-   if .Values.coherence.snapshot.enabled }}
            - name: COH_SNAPSHOT_ENABLED
              value: "true"
{{-   end }}
{{- end }}
{{/* ----- Coherence management variables ----------------------------------- */}}
            - name: COH_MGMT_ENABLED
              value: {{ .Values.coherence.management.enabled | quote }}
{{- if and .Values.coherence.management.enabled .Values.coherence.management.ssl }}
{{-   if .Values.coherence.management.ssl.enabled }}
            - name: COH_MGMT_SSL_ENABLED
              value: {{ .Values.coherence.management.ssl.enabled | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.secrets }}
            - name: COH_MGMT_SSL_CERTS
              value: "/coherence/certs/management"
{{-   end }}
{{-   if .Values.coherence.management.ssl.keyStore }}
            - name: COH_MGMT_SSL_KEYSTORE
              value: {{ .Values.coherence.management.ssl.keyStore | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.keyStorePasswordFile }}
            - name: COH_MGMT_SSL_KEYSTORE_PASSWORD_FILE
              value: {{ .Values.coherence.management.ssl.keyStorePasswordFile | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.keyPasswordFile }}
            - name: COH_MGMT_SSL_KEY_PASSWORD_FILE
              value: {{ .Values.coherence.management.ssl.keyPasswordFile | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.keyStoreAlgorithm }}
            - name: COH_MGMT_SSL_KEYSTORE_ALGORITHM
              value: {{ .Values.coherence.management.ssl.keyStoreAlgorithm | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.keyStoreProvider }}
            - name: COH_MGMT_SSL_KEYSTORE_PROVIDER
              value: {{ .Values.coherence.management.ssl.keyStoreProvider | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.keyStoreType }}
            - name: COH_MGMT_SSL_KEYSTORE_TYPE
              value: {{ .Values.coherence.management.ssl.keyStoreType | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.trustStore }}
            - name: COH_MGMT_SSL_TRUSTSTORE
              value: {{ .Values.coherence.management.ssl.trustStore | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.trustStorePasswordFile }}
            - name: COH_MGMT_SSL_TRUSTSTORE_PASSWORD_FILE
              value: {{ .Values.coherence.management.ssl.trustStorePasswordFile | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.trustStoreAlgorithm }}
            - name: COH_MGMT_SSL_TRUSTSTORE_ALGORITHM
              value: {{ .Values.coherence.management.ssl.trustStoreAlgorithm | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.trustStoreProvider }}
            - name: COH_MGMT_SSL_TRUSTSTORE_PROVIDER
              value: {{ .Values.coherence.management.ssl.trustStoreProvider | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.trustStoreType }}
            - name: COH_MGMT_SSL_TRUSTSTORE_TYPE
              value: {{ .Values.coherence.management.ssl.trustStoreType | quote }}
{{-   end }}
{{-   if .Values.coherence.management.ssl.requireClientCert }}
            - name: COH_MGMT_SSL_REQUIRE_CLIENT_CERT
              value: "true"
{{-   end }}
{{- end }}
{{/* ----- Coherence metrics variables -------------------------------------- */}}
            - name: COH_METRICS_ENABLED
              value: {{ .Values.coherence.metrics.enabled | quote }}
{{- if and .Values.coherence.metrics.enabled .Values.coherence.metrics.ssl }}
{{-   if .Values.coherence.metrics.ssl.enabled }}
            - name: COH_METRICS_SSL_ENABLED
              value: {{ .Values.coherence.metrics.ssl.enabled | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.secrets }}
            - name: COH_METRICS_SSL_CERTS
              value: "/coherence/certs/metrics"
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.keyStore }}
            - name: COH_METRICS_SSL_KEYSTORE
              value: {{ .Values.coherence.metrics.ssl.keyStore | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.keyStorePasswordFile }}
            - name: COH_METRICS_SSL_KEYSTORE_PASSWORD_FILE
              value: {{ .Values.coherence.metrics.ssl.keyStorePasswordFile | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.keyPasswordFile }}
            - name: COH_METRICS_SSL_KEY_PASSWORD_FILE
              value: {{ .Values.coherence.metrics.ssl.keyPasswordFile | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.keyStoreAlgorithm }}
            - name: COH_METRICS_SSL_KEYSTORE_ALGORITHM
              value: {{ .Values.coherence.metrics.ssl.keyStoreAlgorithm | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.keyStoreProvider }}
            - name: COH_METRICS_SSL_KEYSTORE_PROVIDER
              value: {{ .Values.coherence.metrics.ssl.keyStoreProvider | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.keyStoreType }}
            - name: COH_METRICS_SSL_KEYSTORE_TYPE
              value: {{ .Values.coherence.metrics.ssl.keyStoreType | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.trustStore }}
            - name: COH_METRICS_SSL_TRUSTSTORE
              value: {{ .Values.coherence.metrics.ssl.trustStore | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.trustStorePasswordFile }}
            - name: COH_METRICS_SSL_TRUSTSTORE_PASSWORD_FILE
              value: {{ .Values.coherence.metrics.ssl.trustStorePasswordFile | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.trustStoreAlgorithm }}
            - name: COH_METRICS_SSL_TRUSTSTORE_ALGORITHM
              value: {{ .Values.coherence.metrics.ssl.trustStoreAlgorithm | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.trustStoreProvider }}
            - name: COH_METRICS_SSL_TRUSTSTORE_PROVIDER
              value: {{ .Values.coherence.metrics.ssl.trustStoreProvider | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.trustStoreType }}
            - name: COH_METRICS_SSL_TRUSTSTORE_TYPE
              value: {{ .Values.coherence.metrics.ssl.trustStoreType | quote }}
{{-   end }}
{{-   if .Values.coherence.metrics.ssl.requireClientCert }}
            - name: COH_METRICS_SSL_REQUIRE_CLIENT_CERT
              value: "true"
{{-   end }}
{{- end }}
{{/* */}}
{{/* ----- Logging variables ------------------------------------------------ */}}
{{/* */}}
{{- if .Values.logging }}
{{-   if .Values.logging.level }}
            - name: COH_LOG_LEVEL
              value: {{ .Values.logging.level | quote }}
{{-   end }}
{{-   if .Values.logging.configFile }}
{{-     if .Values.logging.configMapName }}
#          Set the logging configuration relative to /loggingconfig mounted from the logging-config ConfigMap volume
            - name: COH_LOGGING_CONFIG
              value: {{ printf "/loggingconfig/%s" .Values.logging.configFile | quote }}
{{-     else if .Values.application.image }}
#          Set the logging configuration relative to user artifacts configuration directory
            - name: COH_LOGGING_CONFIG
              value: {{ printf "%s/%s" $extConfDir .Values.logging.configFile | quote }}
{{-     else }}
#          Set the logging configuration as an absolute file name
            - name: COH_LOGGING_CONFIG
              value: {{ .Values.logging.configFile | quote }}
{{-     end }}
{{-   else }}
#          Use the default logging configuration
            - name: COH_LOGGING_CONFIG
              value: "/scripts/logging.properties"
{{-   end }}
{{- end }}
{{/* */}}
{{/* ------------------------------------------------------------------------ */}}
{{/* */}}
          readinessProbe:
            exec:
              command: [ "/bin/sh", "-x", "/scripts/startCoherence.sh", "probe", "com.oracle.coherence.k8s.PodChecker", "readiness" ]
            initialDelaySeconds: {{default 30 .Values.readinessProbe.initialDelaySeconds }}
            periodSeconds:       {{default 60 .Values.readinessProbe.periodSeconds }}
            failureThreshold:    {{default 50 .Values.readinessProbe.failureThreshold }}
            successThreshold:    {{ .Values.readinessProbe.successThreshold }}
            timeoutSeconds:      {{default 5 .Values.readinessProbe.timeoutSeconds }}
          livenessProbe:
            exec:
              command: [ "/bin/sh", "-x", "/scripts/startCoherence.sh", "probe", "com.oracle.coherence.k8s.PodChecker", "liveness" ]
            initialDelaySeconds: 45
            periodSeconds: 60
            failureThreshold: 5
{{/* */}}
{{/* ------------------------------------------------------------------------ */}}
{{/* */}}
          command: [ "/bin/sh", "-x", "/scripts/startCoherence.sh", "server" ]
{{/* */}}
{{/* ------------------------------------------------------------------------ */}}
{{/* */}}
{{- if .Values.resources }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
{{- end }}
{{/* */}}
{{/* ----- Volume Mounts ---------------------------------------------------- */}}
{{/* */}}
          volumeMounts:
            - name: log-dir
              mountPath: /logs
              readOnly: false
            - name: utils-dir
              mountPath: /utils
            - name: application-artifacts-dir
              mountPath: {{ $extLibDir | quote }}
            - name: application-conf-dir
              mountPath: {{ $extConfDir | quote }}
            - name: coherence-scripts
              mountPath: /scripts
{{- if .Values.volumeMounts }}
{{ toYaml .Values.volumeMounts | indent 12 }}
{{- end }}
{{- if .Values.logging }}
{{-   if .Values.logging.configMapName }}
            - name: logging-config
              mountPath: /loggingconfig
{{-   end }}
{{- end }}
{{- if .Values.coherence.management.ssl }}
{{-   if .Values.coherence.management.ssl.secrets }}
            - name: management-ssl-config
              mountPath: /coherence/certs/management
              readOnly: true
{{-   end }}
{{- end }}
{{- if .Values.coherence.metrics.ssl }}
{{-   if .Values.coherence.metrics.ssl.secrets }}
            - name: metrics-ssl-config
              mountPath: /coherence/certs/metrics
              readOnly: true
{{-   end }}
{{- end }}
{{- if .Values.coherence.persistence }}
{{-   if .Values.coherence.persistence.enabled }}
            - mountPath: "/persistence"
              name: persistence-volume
{{-   end }}
{{- end }}
{{- if .Values.coherence.snapshot }}
{{-   if .Values.coherence.snapshot.enabled }}
            - mountPath: "/snapshot"
              name: snapshot-volume
{{-   else if .Values.coherence.snapshot.volume }}
{{-     if .Values.coherence.persistence }}
{{-       if .Values.coherence.persistence.enabled }}
{{- include "rootCoherenceSnapshot" . | indent 12 }}
{{-       end }}
{{-     else }}
{{- include "rootCoherenceSnapshot" . | indent 12 }}
{{-     end }}
{{-   end }}
{{- end }}
{{- if .Values.logging.fluentd.enabled }}
# ---------------------------------------------------------------------------
#  Container: fluentd
# ---------------------------------------------------------------------------
        - name: fluentd
          image: {{ .Values.logging.fluentd.image }}
          imagePullPolicy: {{ .Values.logging.fluentd.imagePullPolicy | default "IfNotPresent" }}
          args: ["-c", "/etc/fluent.conf"]
          env:
            - name: COHERENCE_POD_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: FLUENTD_CONF
              value: fluentd-coherence.conf
            - name: FLUENT_ELASTICSEARCH_SED_DISABLE
              value: "true"
            - name: ELASTICSEARCH_HOST
              valueFrom:
                secretKeyRef:
                  name: coherence-monitoring-config
                  key: elasticsearchhost
            - name: ELASTICSEARCH_PORT
              valueFrom:
                secretKeyRef:
                  name: coherence-monitoring-config
                  key: elasticsearchport
            - name: ELASTICSEARCH_USER
              valueFrom:
                secretKeyRef:
                  name: coherence-monitoring-config
                  key: elasticsearchuser
            - name: ELASTICSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: coherence-monitoring-config
                  key: elasticsearchpassword
          volumeMounts:
            - mountPath: /fluentd/etc/fluentd-coherence.conf
              subPath: fluentd-coherence.conf
              name: fluentd-coherence-conf
            - mountPath: /logs
              name: log-dir
            - mountPath: /conf
              name: application-conf-dir

{{- end }}
# ---------------------------------------------------------------------------
#  Volumes
# ---------------------------------------------------------------------------
      volumes:
#       The logs directory
        - name: log-dir
          emptyDir:
            medium:
#       The utility files and scripts directory
        - name: utils-dir
          emptyDir: {}
#       The user artifacts to add to the class path
        - name: application-artifacts-dir
          emptyDir: {}
#       The user configuration files to add to the class path
        - name: application-conf-dir
          emptyDir: {}
#       The scripts loaded from a ConfigMap generated by the Helm chart
        - name: coherence-scripts
          configMap:
            name: {{ template "coherence.fullname" . }}-scripts
            defaultMode: 0777
{{- if .Values.logging }}
{{-   if .Values.logging.configMapName }}
#       The scripts loaded from a ConfigMap generated by the Helm chart
        - name: logging-config
          configMap:
            name: {{ .Values.logging.configMapName }}
            defaultMode: 0777
{{-   end }}
{{- end }}
{{- if .Values.coherence.management.ssl }}
{{-   if .Values.coherence.management.ssl.secrets }}
#       The Management SSL certs and passwords are loaded from existing k8s secrets
        - name: management-ssl-config
          secret:
            secretName: {{ .Values.coherence.management.ssl.secrets }}
            defaultMode: 0777
{{-   end }}
{{- end }}
{{- if .Values.coherence.metrics.ssl }}
{{-   if .Values.coherence.metrics.ssl.secrets }}
#       The Metrics SSL certs and passwords are loaded from existing k8s secrets
        - name: metrics-ssl-config
          secret:
            secretName: {{ .Values.coherence.metrics.ssl.secrets }}
            defaultMode: 0777
{{-   end }}
{{- end }}
{{- if .Values.coherence.persistence }}
{{-   if .Values.coherence.persistence.volume }}
{{ toYaml .Values.coherence.persistence.volume | indent 10 }}
{{-   end }}
{{- end }}
{{- if .Values.coherence.snapshot }}
{{-   if .Values.coherence.snapshot.volume }}
{{ toYaml .Values.coherence.snapshot.volume | indent 10 }}
{{-   end }}
{{- end }}
{{- if .Values.volumes }}
{{ toYaml .Values.volumes | indent 8 }}
{{- end }}
{{- if .Values.logging.fluentd.enabled }}
        - name: fluentd-coherence-conf
          configMap:
            name: {{ template "coherence.fullname" . }}-efk-config
            defaultMode: 420
{{- end }}
# ---------------------------------------------------------------------------
#  Volumes claim templates
# ---------------------------------------------------------------------------
  volumeClaimTemplates:
{{- if .Values.coherence.persistence }}
{{-   if .Values.coherence.persistence.enabled }}
{{-     if not .Values.coherence.persistence.volume }}
    - metadata:
        name: persistence-volume
        labels:
{{- include "coherence.release_labels" . | indent 10 }}
          component: "coherence-vol"
      spec:
{{-       if .Values.coherence.persistence.persistentVolumeClaim }}
{{ toYaml .Values.coherence.persistence.persistentVolumeClaim | indent 8 }}
{{-       end }}
{{-     end }}
{{-   end }}
{{- end }}
{{- if .Values.coherence.snapshot }}
{{-   if .Values.coherence.snapshot.enabled }}
{{-     if not .Values.coherence.snapshot.volume }}
    - metadata:
        name: snapshot-volume
        labels:
{{- include "coherence.release_labels" . | indent 10 }}
          component: "coherence-vol"
      spec:
{{-       if .Values.coherence.snapshot.persistentVolumeClaim }}
{{ toYaml .Values.coherence.snapshot.persistentVolumeClaim | indent 8 }}
{{-       end }}
{{-     end }}
{{-   end }}
{{- end }}
{{- if .Values.volumeClaimTemplates }}
{{ toYaml .Values.volumeClaimTemplates | indent 4 }}
{{- end }}
